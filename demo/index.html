<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <!-- // <script src="d3.v3.min.js"></script> -->
    <script src="d3.v4.js"></script>
    <script src="colorbrewer.js"></script>
    <script src="../build/organogram.js"></script>
  </head>
  <body>
    <script type="text/javascript">
var diameter = 2000;

var colour = function colour(i) {
  if (i >= 0) return colorbrewer.Set1[7][i];
  return "grey";
};

var tree = d3.tree()
    .size([360, diameter / 2 - 200])
    .separation(function(a, b) { return (a.parent == b.parent ? 0.66 : 2) / a.depth; });

var svg = organogram.svg("organogram", diameter),
    width = +svg.attr("width"),
    height = +svg.attr("height"),
    g = svg.append("g").attr("transform", "translate(" + (width / 2 + 40) + "," + (height / 2 + 90) + ")");

var stratify = d3.stratify()
    .id(function(d) { return d.reference; })
    .parentId(function(d) { return d.report_to; });

var rootId = "5";

d3.csv("NDR ESR Staff List 1.11.16.csv", function(d) {
  // E-mail address (by exception)
  return {
    // post_title: d["Post Title"],
    // primary_role: d["Primary Role"],
    // division: d["Division"],
    // esr_cost_centre: d["ESR Cost Centre"],
    // new_esr_cost_centre: d["New ESR Cost Centre"],
    reference: d["Reference"],

    current_report_to: d["Current Report to"],
    report_to: d["Reference"] == rootId ? '' : d["Proposed Report to"],
    // report_to: d["Current Report to"],

    employee_name: d["Employee Name"],
    label: d["First Name"] + " " + d["Last Name"],
    // esr_assignment_category: d["ESR Assignment Category"],
    pay_grade: d["Pay Grade"],
    colour: colour(organogram.gradeIndex(d["Pay Grade"])),
    wte: +d["WTE"],
    position_number: d["Position Number"],
    employee_number: d["Employee Number"],
    // location: d["Location"],
    // notes: d["Notes"]
  };
}, function(error, rows) {
  if (error) throw error;
  // filter the rows to children and the selected root (to avoid multiple roots)
  rows = rows.filter(function(d){ return stratify.parentId()(d) != '' || stratify.id()(d) == rootId; });
  rows = rows.filter(function(d){ return d.report_to != '60051' && d.report_to != '600601'; });

  var root = tree(stratify(rows));
  var link = organogram.link(g, root, organogram.diagonal);

  var node = g.selectAll(".node")
      .data(root.descendants())
    .enter().append("g")
      .attr("class", "node")
      // .attr("class", function(d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
      // .attr("transform", function(d) { return "translate(" + organogram.project(d.x, d.y) + ")"; });
      .attr("transform", function(d) {
        return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")";
      })

  node.append("circle")
      .attr("r", function(d) {
        if (isNaN(d.data.wte) || d.data.wte == 0) return 0;
        var radius = 5 * Math.sqrt(d.data.wte);
        return radius;
      })
      .attr("fill", function(d) {
        if (d.data.label == "Dis-est.") return "#ccc";
        return d.data.colour;
      })
      ;

  node.append("text")
      .attr("dy", ".31em")
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function(d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
      .style("fill", function(d){
        return (d.data.employee_name.match(/(vacant|dis-est|frozen|delete)/i) ? "#aaa" : "#333");
      })

  .attr("font-size", "10px")
  .attr("font-family", "sans-serif")
      .text(function(d) {
        return d.data.employee_name.match(/vacant/i) ? "" + d.data.position_number : d.data.label
      });

  organogram.download(document, "organogram");
});

d3.select(self.frameElement).style("height", diameter - 150 + "px");
    </script>
  </body>
</html>
