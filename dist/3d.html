<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <title>Organogram</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
    </style>
  </head>
  <body>
    <script src="d3.v4.js"></script>
    <script src="colorbrewer.js"></script>
    <script src="organogram_3d.js"></script>
    <script src="three.js"></script>
    <script>
      var gradeIndex = function(grade) {
        grade = '' + grade;
        if (grade.match(/^(SCS1|AFC8D)/)) {
          return -1;
        } else if (grade.match(/^(G6|Grade 6|AFC8C)/)) {
          return 0;
        } else if (grade.match(/^(G7U|Grade 7 Upper|AFC8B)/)) {
          return 1;
        } else if (grade.match(/^(G7|Grade 7|AFC8A)/)) {
          return 2;
        } else if (grade.match(/^(SEO|AFC7)/)) {
          return 3;
        } else if (grade.match(/^(HEO|AFC6|DQ00)/)) {
          return 4;
        } else if (grade.match(/^(EO|AFC5)/)) {
          return 5;
        } else if (grade.match(/^(AO|AFC4)/)) {
          return 6;
        } else if (grade.match(/^(AA|AFC3)/)) {
          return 7;
        } else {
          // console.log(grade);
          return -1;
        }
      }

      // Our Javascript will go here.
      var targetRotation = - Math.PI / 2;
      var targetRotationOnMouseDown = 0;

      var mouseX = 0;
      var mouseXOnMouseDown = 0;
      var heightMultiplier = 2;

      var windowHalfX = window.innerWidth / 2;
      var windowHalfY = window.innerHeight / 2;

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
      camera.position.z = 325;

      // var light = new THREE.PointLight( 0xffffff, 0.8 );
      // camera.add( light );

      var renderer = new THREE.WebGLRenderer( { antialias: true } );
      renderer.setClearColor( 0xffffff );
      renderer.setPixelRatio( window.devicePixelRatio );
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      group = new THREE.Group();
      group.position.y = 200;
      // group.rotation.x = 0.75;
      group.rotation.x = 0.2;
      group.rotation.y = Math.PI / 2;
      scene.add( group );

      // var geometry = new THREE.BoxGeometry( 1, 1, 1 );
      // var material = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
      // var cube = new THREE.Mesh( geometry, material );
      // cube.position.set( 10, 0, 0 );
      // group.add( cube );
      //
      // var geometry = new THREE.BoxGeometry( 1, 1, 1 );
      // var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
      // var cube = new THREE.Mesh( geometry, material );
      // cube.position.set( 0, 10, 0 );
      // group.add( cube );
      //
      // var geometry = new THREE.BoxGeometry( 1, 1, 1 );
      // var material = new THREE.MeshBasicMaterial( { color: 0x0000ff } );
      // var cube = new THREE.Mesh( geometry, material );
      // cube.position.set( 0, 0, 10 );
      // group.add( cube );

      var diameter = 50;

      var colour = function colour(i) {
        if (i >= 0) return colorbrewer.Set1[7][i];
        return "grey";
      };

      var project_xyz = function project_xyz(d) {
        var projected_xy = organogram.project(d.x, d.y);
        return [projected_xy[0], d.y * heightMultiplier, projected_xy[1]];
      };

      var tree = d3.tree()
          .size([360, diameter / 2 - 200])
          .separation(function(a, b) { return (a.parent == b.parent ? 1.1 : 2) / a.depth; });

      var stratify = d3.stratify()
          .id(function(d) { return d.reference; })
          .parentId(function(d) { return d.report_to; });

      var rootId = "5";

      var loader = new THREE.FontLoader();
      loader.load( 'helvetiker_regular.typeface.json', function ( font ) {
        init( font );
        animate();
      } );

      function init( font ) {
        referenceColumnName = "Reference";
        reportToColumnName = "Report to";
        wteColumnName = "Budgeted WTE";
        payGrade = "Actual Pay Grade/Scale";
        // payGrade = "Budgeted Pay Grade"
        // referenceColumnName = "Post Unique Reference";
        // reportToColumnName = "Reports to Senior Post";
        // wteColumnName = "FTE";

        d3.csv("NDR ESR Staff List 5.12.19amended.csv", function(d) {
          // E-mail address (by exception)
          return {
            reference: d[referenceColumnName],
            report_to: d[referenceColumnName] == rootId ? '' : d[reportToColumnName],
            label: '' + d["Post Title"],
            // label: ('' + d["Employee Name"]).match(/vacant/i) ? "" + d["New ESR"] : d["Preferred First Name"] + " " + d["Last Name"],
            label_colour: ('' + d["Employee Name"]).match(/(vacant|dis-est|frozen|delete)/i) ? "#aaa" : "#333",
            pay_grade: d[payGrade],
            grade_index: gradeIndex(d[payGrade]),
            colour: colour(gradeIndex(d[payGrade])),
            wte: +d[wteColumnName],

            employee_name: d["Employee Name"],
            position_number: d["Position Number"],
            employee_number: d["Employee Number"],
          };
        }, function(error, rows) {
          if (error) throw error;
          // filter seemingly empty rows
          rows = rows.filter(function(d){ return 'undefined' !== typeof d.reference && 'undefined' !== typeof d.report_to });

          // filter the rows to children and the selected root (to avoid multiple roots)
          rows = rows.filter(function(d){ return stratify.parentId()(d) != '' || stratify.id()(d) == rootId; });
          rows = rows.filter(function(d){ return d.report_to != '60051' && d.report_to != '600601'; });

          var root = tree(stratify(rows));

          nodes = root.descendants();

          for( var i = 0; i < nodes.length; i ++ ) {
            d = nodes[i];
            // console.log(d.x);
            projected_xyz = project_xyz(d);

            // console.log(projected_xy);

            var geometry = new THREE.SphereGeometry(2);
            // var geometry = new THREE.SphereGeometry( (isNaN(d.data.wte) || d.data.wte == 0) ? 0 : 2 * Math.sqrt(d.data.wte) );
            var material = new THREE.MeshBasicMaterial( {color: d.data.label == "Dis-est." ? "#ccc" : d.data.colour } );
            var sphere = new THREE.Mesh( geometry, material );
            sphere.position.set( projected_xyz[0], projected_xyz[1], projected_xyz[2] );
            group.add( sphere );

            // Get text from hash
            var theText = d.data.employee_name.match(/vacant/i) ? "" + d.data.position_number : d.data.label;

            var geometry = new THREE.TextGeometry( theText, {
              font: font,
              size: 3,
              height: 0.1,
              curveSegments: 2
            });

            geometry.computeBoundingBox();
            // var centerOffset = -0.5 * ( geometry.boundingBox.max.x - geometry.boundingBox.min.x );

            var material = new THREE.MeshBasicMaterial( { color: 0x666666 } );
            var mesh = new THREE.Mesh( geometry, material );

            // mesh.position.x = centerOffset;
            // mesh.position.y = 100;
            // mesh.position.z = 0;
            text_projected_xy = organogram.project(d.x, d.y - 3);
            mesh.position.set( text_projected_xy[0], d.y * heightMultiplier, text_projected_xy[1] );

            mesh.rotation.x = 0;
            // mesh.rotation.y = 0;
            mesh.rotation.y = 2 * Math.PI - ((d.x + 90) / 180 * Math.PI);
            // mesh.rotation.z = -1;

            group.add( mesh );

            if (d.parent) {
              parent_projected_xyz = project_xyz(d.parent);
              handle1_xyz = project_xyz({ x: d.parent.x + ((d.x - d.parent.x) * 1 / 16), y: d.parent.y + ((d.y - d.parent.y) * 1 / 3) });
              handle2_xyz = project_xyz({ x: d.x, y: d.parent.y + ((d.y - d.parent.y) * 5 / 6) });

              var curve;
              if (d.parent.depth == 0) {
                curve = new THREE.CatmullRomCurve3( [
                  new THREE.Vector3( parent_projected_xyz[0], parent_projected_xyz[1], parent_projected_xyz[2] ),
                  sphere.position
                ] );
              } else {
                curve = new THREE.CatmullRomCurve3( [
                  new THREE.Vector3( parent_projected_xyz[0], parent_projected_xyz[1], parent_projected_xyz[2] ),
                  new THREE.Vector3( handle1_xyz[0], handle1_xyz[1], handle1_xyz[2] ),
                  new THREE.Vector3( handle2_xyz[0], handle2_xyz[1], handle2_xyz[2] ),
                  sphere.position
                ] );
              }
              curve.type = 'chordal';

              var geometry = new THREE.Geometry();
              geometry.vertices = curve.getPoints( 50 );

              var material = new THREE.LineBasicMaterial( { color : d.parent.data.grade_index > d.data.grade_index ? "red" : "#ccc" } );

              // Create the final object to add to the scene
              var curveObject = new THREE.Line( geometry, material );
              group.add( curveObject );
            }
          };


          // node.append("text")
          //     .attr("dy", ".31em")
          //     .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
          //     .attr("transform", function(d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
          //     .style("fill", function(d){
          //       return (d.data.employee_name.match(/(vacant|dis-est|frozen|delete)/i) ? "#aaa" : "#333");
          //     })
          //
          // .attr("font-size", "10px")
          // .attr("font-family", "sans-serif")
          //     .text(function(d) {
          //       return d.data.employee_name.match(/vacant/i) ? "" + d.data.position_number : d.data.label
          //     });

        });
      }

      function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );
      }

      //
      function onDocumentMouseDown( event ) {
        event.preventDefault();

        document.addEventListener( 'mousemove', onDocumentMouseMove, false );
        document.addEventListener( 'mouseup', onDocumentMouseUp, false );
        document.addEventListener( 'mouseout', onDocumentMouseOut, false );

        mouseXOnMouseDown = event.clientX - windowHalfX;
        targetRotationOnMouseDown = targetRotation;
      }

      function onDocumentMouseMove( event ) {
        mouseX = event.clientX - windowHalfX;

        targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.02;
      }

      function onDocumentMouseUp( event ) {
        document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
        document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
        document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
      }

      function onDocumentMouseOut( event ) {
        document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
        document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
        document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
      }

      function onDocumentTouchStart( event ) {
        if ( event.touches.length == 1 ) {
          event.preventDefault();

          mouseXOnMouseDown = event.touches[ 0 ].pageX - windowHalfX;
          targetRotationOnMouseDown = targetRotation;
        }
      }

      function onDocumentTouchMove( event ) {
        if ( event.touches.length == 1 ) {
          event.preventDefault();

          mouseX = event.touches[ 0 ].pageX - windowHalfX;
          targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.05;
        }
      }

      //
      function animate() {
        requestAnimationFrame( animate );

        render();
      }

      function render() {
        group.rotation.y += ( targetRotation - group.rotation.y ) * 0.02;
        // group.rotation.y += 0.01;
        renderer.render( scene, camera );
      }

      document.addEventListener( 'mousedown', onDocumentMouseDown, false );
      document.addEventListener( 'touchstart', onDocumentTouchStart, false );
      document.addEventListener( 'touchmove', onDocumentTouchMove, false );
      window.addEventListener( 'resize', onWindowResize, false );
    </script>
  </body>
</html>
